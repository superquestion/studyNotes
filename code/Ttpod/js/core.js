$.module("Ttpod.core",function(){"use strict";function _isCrossDomain(e){var t=$.query.parseURL(e);return!(_mainRoot.host==t.host&&_mainRoot.port==t.port)}function _resolveAction(e){if(e=$.extend({domain:"",isProxy:_config.isProxy,protocol:"http:"},e),!("path"in e))return"";var t=e.isProxy&&""!=e.domain&&_mainRoot.host!=e.domain;return e=t?"/ajax/"+e.domain+e.path:e.protocol+"//"+e.domain+e.path}function _resoveActionObj(e){for(var t in e){var o=e[t];$.isPlainObject(o)&&!$.isEmptyObject(o)&&("path"in o?e[t]=_resolveAction(o):_resoveActionObj(o))}}var _isInit=!1,_version="@VERSION@",_UID="",_mainRoot=$.query.parseURL(),_outTypes=/^(log|debug|info|warn|error)$/,_tmpls={},_actions={},_errorHandler={},_config=Ttpod.config||{},_options={logUrl:"http://collect.log.ttpod.com/www/i.png",tmplPrefix:"tmpl-",isCacheTmpl:!1,dataType:"json",dataFormat:!0,domain:"dongting.com"},_isInitServerConfig=!1,_serverConfig={version:0};return{setOptions:function(e){$.extend(_options,e||{})},initServerConfig:function(e,t){var o=this;if(_serverConfig=$.extend(_serverConfig,e,this.store("serverConfig")),!$.isEmptyObject(t)){var r=t.success;t=$.extend({async:!1},t),t.success=function(e){o.setServerConfig(e.data),$.isFunction(r)&&r.apply(this,arguments)},Ttpod.core.getResult(t)}_isInitServerConfig=!0},getServerConfig:function(e){return _isInitServerConfig||this.initServerConfig(),e&&!$.isEmptyObject(_serverConfig)?_serverConfig[e]:_serverConfig},setServerConfig:function(e){_isInitServerConfig||this.initServerConfig(),$.extend(_serverConfig,e),this.store("serverConfig",_serverConfig)},setConfig:function(e){_config=e},isRelease:function(){return"release"==_config.mode},getURI:function(e,t,o){var r=t?_config.domain[t]:location.host,n=r?"http://"+r+e:e;return o===!0&&(o=_config.version),o&&(n=$.query.set("v",o,n)),n},getAction:function(e){for(var t=e.split("."),o=0,r=!0,n=_actions;o<t.length&&r;){var i=t[o];if(!n[i]){n="",r=!1;break}n=n[i],o++}return n},setAction:function(e){$.isPlainObject(e)&&!$.isEmptyObject(e)&&(_resoveActionObj(e),$.extend(_actions,e)),this.out("actions",_actions)},resolveAction:_resolveAction,template:function(e,t){if(!e)return"";if(t=t||{},0!=e.indexOf(_options.tmplPrefix))return $.template(e,t);var o=_tmpls[e];if(!$.isFunction(o)){var r=document.getElementById(e);r?o=$.template(e):this.ajax({url:Ttpod.core.getURI("/"+e.replace(/-/g,"/")+".html","",!0),cache:Ttpod.core.isRelease(),cacheKey:_options.isCacheTmpl?e:"",cacheVersion:_config.version,async:!1,dataType:"html",success:function(e){o=$.template(e)}})}return o?(_tmpls[e]=o,o(t)):(Ttpod.core.out("模板加载失败","error"),"")},getResult:function(e){$.isEmptyObject(e)||(e=$.extend({type:"GET",dataType:_options.dataType,cache:!0,format:e.type&&"GET"!=e.type?!1:_options.dataFormat,data:{}},e),this.ajax(e))},setResult:function(e){$.isEmptyObject(e)||(e=$.extend({type:"POST",dataType:_options.dataType,cache:!1,format:"GET"==e.type?!0:!1,data:{}},e),this.ajax(e))},ajax:function(e){if(!$.isEmptyObject(e)&&(e.url||e.action)){e.url||(e.url=this.getAction(e.action));var t,o=this,r=(e.url,""),n="",i=e.cacheKey&&o.isRelease()&&!e.requireToken;if(i){t=e.cacheVersion||o.getServerConfig("version");var s=o.getCacheResult(e.cacheKey,t);if($.exists(s))return $.isFunction(e.success)&&e.success(s,"cache"),void 0}if(e.requireToken){var c=Ttpod.user.getUserInfo();if($.isEmptyObject(c))return Ttpod.user.login();r=c.access_token,n=c.tuid}var a=e.success,u=e.error,l=e.data;/^http/i.test(e.url)&&_isCrossDomain(e.url)&&(e.url=e.url.replace(/[\#&]*$/,""),e.url+=-1==e.url.indexOf("?")&&-1==e.url.indexOf("#")?"?callback=?":"&callback=?"),e.requireToken&&(e.data.access_token=r,e.data.tuid=n),e.format&&("string"==typeof e.jsonpCallback&&(e.data.callback=e.jsonpCallback),e.url=$.formatByVal(e.url,e.data,!0),e.data=e.requireToken?{access_token:r,tuid:n}:{}),e.success=function(r,n,s){if(o.resolveResult(r))$.isPlainObject(r)&&(r.params=l),$.isFunction(a)&&a.apply(this,arguments),i&&o.setCacheResult(e.cacheKey,t,r),"html"!=e.dataType&&o.out(e.url,r);else{var c,n="service";r.errorThrown=n,$.isFunction(u)&&(c=u(s,n,r),0!=c&&0==r.code&&(c=!0)),!0!==c&&o.resolveError(r),o.out(e.url,r,"warn")}},e.error=function(t,r,n){var i,s={code:0,msg:"string"==typeof n?n:r,errorThrown:n};$.isFunction(u)&&(i=u(t,r,s)),!0!==i&&o.resolveError(s),o.out(e.url,"error")},$.ajax(e)}},resolveResult:function(result,hasHandler){if($.isEmptyObject(result)||!$.exists(result.code))return!0;if("string"==typeof result&&0==result.search(/^\{"code"/i)&&(result=eval("("+result+")")),result.code=parseInt(result.code),1==result.code)return!0;var handler=_errorHandler[result.code];return result.msg=$.isPlainObject(handler)&&!$.isEmptyObject(handler.msg)?handler.msg:result.msg||"服务器繁忙,请稍后再试！",!1},getErrorMsg:function(e,t){return t},setErrorHandler:function(e){$.extend(_errorHandler,e)},resolveError:function(e){var t=_errorHandler[e.code],o=$.isPlainObject(t)?t.handler:t;1!=e.code&&$.isFunction(o)&&o.call(this,e)},getCacheResult:function(e,t){var o=this.store(e);return $.exists(t)?!$.isEmptyObject(o)&&"version"in o&&"content"in o?0==t||o.version==t?o.content:null:null:o},setCacheResult:function(e,t,o){this.store(e,{version:t||0,content:o})},store:function(e,t,o){return"store"in $?(e=o&&"prefix"in o?(o.prefix?o.prefix+"_":"")+e:(_config.site+"_"+e).toUpperCase(),"undefined"==typeof t?$.store.get(e):null!=t?$.store.set(e,t):($.store.remove(e),void 0)):Ttpod.core.out("Ttpod.core.store","ReferenceError: $.store is not defined","error")},cookie:function(e,t,o){return"cookie"in $?(e=o&&"prefix"in o?(o.prefix?o.prefix+"_":"")+e:(_config.site+"_"+e).toUpperCase(),$.cookie(e,t,o)):Ttpod.core.out("Ttpod.core.cookie","ReferenceError: $.cookie is not defined","error")},out:function(){if(!this.isRelease()){var e=arguments,t=e.length,o=_outTypes.test(e[t-1]),r=o?e[t-1]:"debug",n="Ttpod-"+(t>1&&!o||t>2?e[0]:_config.site),i=t>1&&!o||t>2?e[1]:e[0];try{window.console&&(window.console.group(n),window.console[r](i),window.console.groupEnd())}catch(s){}"error"==r&&this.log({a:"error",data:i})}},getUID:function(){if(_UID=_UID||$.cookie("UID"),!_UID){var e=(new Date).getTime();_UID=e+"."+Math.floor(1e4*Math.random(e));var t={expires:365};Ttpod.core.isRelease()&&(t.domain=_options.domain),$.cookie("UID",_UID,t)}return _UID},log:function(e,t){t=t||_options.logUrl,e=$.extend({},{project:_config.domain.main,version:_config.version,from:_config.from,uid:this.getUID(),t:(new Date).getTime()},e),Ttpod.user&&$.isFunction(Ttpod.user.isLogin)&&Ttpod.user.isLogin()&&(e.tuid=Ttpod.user.getUserInfo("tuid"));for(var o in e)$.exists(e[o])&&"undefined"!=e[o]&&"null"!=e[o]||(e[o]="");(new Image).src=t+(-1==t.indexOf("?")?"?":"&")+$.param(e)},time:function(e){!this.isRelease()&&window.console&&$.isFunction(console.time)&&console.time(e)},timeEnd:function(e){!this.isRelease()&&window.console&&$.isFunction(console.timeEnd)&&console.timeEnd(e)}}});